{
 "cells": [
  {
   "cell_type": "markdown",
   "metadata": {},
   "source": [
    "# Making an Anomalous Difference Map  \n",
    "\n",
    "In [Basics](basics.ipynb), we loaded a room-temperature dataset that was collected at ~6550 eV of tetragonal HEWL. Let's now use that data to generate an anomalous difference map based on the native anomalous signal from sulfur atoms."
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 1,
   "metadata": {},
   "outputs": [],
   "source": [
    "import reciprocalspaceship as rs\n",
    "from reciprocalspaceship import algorithms\n",
    "import numpy as np"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 2,
   "metadata": {},
   "outputs": [
    {
     "data": {
      "text/html": [
       "<div>\n",
       "<style scoped>\n",
       "    .dataframe tbody tr th:only-of-type {\n",
       "        vertical-align: middle;\n",
       "    }\n",
       "\n",
       "    .dataframe tbody tr th {\n",
       "        vertical-align: top;\n",
       "    }\n",
       "\n",
       "    .dataframe thead th {\n",
       "        text-align: right;\n",
       "    }\n",
       "</style>\n",
       "<table border=\"1\" class=\"dataframe\">\n",
       "  <thead>\n",
       "    <tr style=\"text-align: right;\">\n",
       "      <th></th>\n",
       "      <th></th>\n",
       "      <th></th>\n",
       "      <th>FreeR_flag</th>\n",
       "      <th>IMEAN</th>\n",
       "      <th>SIGIMEAN</th>\n",
       "      <th>I(+)</th>\n",
       "      <th>SIGI(+)</th>\n",
       "      <th>I(-)</th>\n",
       "      <th>SIGI(-)</th>\n",
       "      <th>N(+)</th>\n",
       "      <th>N(-)</th>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>H</th>\n",
       "      <th>K</th>\n",
       "      <th>L</th>\n",
       "      <th></th>\n",
       "      <th></th>\n",
       "      <th></th>\n",
       "      <th></th>\n",
       "      <th></th>\n",
       "      <th></th>\n",
       "      <th></th>\n",
       "      <th></th>\n",
       "      <th></th>\n",
       "    </tr>\n",
       "  </thead>\n",
       "  <tbody>\n",
       "    <tr>\n",
       "      <th rowspan=\"5\" valign=\"top\">0</th>\n",
       "      <th rowspan=\"5\" valign=\"top\">0</th>\n",
       "      <th>4</th>\n",
       "      <td>14</td>\n",
       "      <td>671.0396</td>\n",
       "      <td>22.205784</td>\n",
       "      <td>671.0396</td>\n",
       "      <td>22.205784</td>\n",
       "      <td>671.0396</td>\n",
       "      <td>22.205784</td>\n",
       "      <td>16</td>\n",
       "      <td>16</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>8</th>\n",
       "      <td>4</td>\n",
       "      <td>3273.7385</td>\n",
       "      <td>107.59589</td>\n",
       "      <td>3273.7385</td>\n",
       "      <td>107.59589</td>\n",
       "      <td>3273.7385</td>\n",
       "      <td>107.59589</td>\n",
       "      <td>16</td>\n",
       "      <td>16</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>12</th>\n",
       "      <td>6</td>\n",
       "      <td>1367.5679</td>\n",
       "      <td>43.352566</td>\n",
       "      <td>1367.5679</td>\n",
       "      <td>43.352566</td>\n",
       "      <td>1367.5679</td>\n",
       "      <td>43.352566</td>\n",
       "      <td>16</td>\n",
       "      <td>16</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>16</th>\n",
       "      <td>19</td>\n",
       "      <td>4158.55</td>\n",
       "      <td>198.88382</td>\n",
       "      <td>4158.55</td>\n",
       "      <td>198.88382</td>\n",
       "      <td>4158.55</td>\n",
       "      <td>198.88382</td>\n",
       "      <td>8</td>\n",
       "      <td>8</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>20</th>\n",
       "      <td>8</td>\n",
       "      <td>2.4992087</td>\n",
       "      <td>5.7103205</td>\n",
       "      <td>2.4992087</td>\n",
       "      <td>5.7103205</td>\n",
       "      <td>2.4992087</td>\n",
       "      <td>5.7103205</td>\n",
       "      <td>1</td>\n",
       "      <td>1</td>\n",
       "    </tr>\n",
       "  </tbody>\n",
       "</table>\n",
       "</div>"
      ],
      "text/plain": [
       "        FreeR_flag     IMEAN  SIGIMEAN      I(+)   SIGI(+)      I(-)  \\\n",
       "H K L                                                                  \n",
       "0 0 4           14  671.0396 22.205784  671.0396 22.205784  671.0396   \n",
       "    8            4 3273.7385 107.59589 3273.7385 107.59589 3273.7385   \n",
       "    12           6 1367.5679 43.352566 1367.5679 43.352566 1367.5679   \n",
       "    16          19   4158.55 198.88382   4158.55 198.88382   4158.55   \n",
       "    20           8 2.4992087 5.7103205 2.4992087 5.7103205 2.4992087   \n",
       "\n",
       "         SIGI(-)  N(+)  N(-)  \n",
       "H K L                         \n",
       "0 0 4  22.205784    16    16  \n",
       "    8  107.59589    16    16  \n",
       "    12 43.352566    16    16  \n",
       "    16 198.88382     8     8  \n",
       "    20 5.7103205     1     1  "
      ]
     },
     "execution_count": 2,
     "metadata": {},
     "output_type": "execute_result"
    }
   ],
   "source": [
    "refltable = rs.read_mtz(\"data/HEWL_SSAD_24IDC.mtz\")\n",
    "refltable.head()"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 3,
   "metadata": {},
   "outputs": [
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "Number of reflections: 12563\n"
     ]
    }
   ],
   "source": [
    "print(f\"Number of reflections: {len(refltable)}\")"
   ]
  },
  {
   "cell_type": "markdown",
   "metadata": {},
   "source": [
    "---\n",
    "### Background\n",
    "\n",
    "Since this dataset was collected at a single wavelength, we can compute an anomalous difference map from the anomalous structure factor amplitudes, $|F_{A}|$, and their phase shifts, $\\alpha$, relative to the computed phases from an isomorphous structure of tetragonal HEWL. We will compute $|F_{A}|$ based on the following:\n",
    "\n",
    "\\begin{equation*}\n",
    "|F_{A}| \\propto \\Delta_{\\mathrm{ano}} = |F_{HKL}| - |F_{\\overline{HKL}}|\n",
    "\\end{equation*}\n",
    "\n",
    "We will then use the PDB: 1VAT and `phenix.fmodel` to compute isomorphous phases, $\\phi_c$, which can be used to determine the phases for the anomalous contribution, $\\phi_A$, using the phase shift, $\\alpha$:\n",
    "\n",
    "\\begin{equation*}\n",
    "\\phi_A = \\phi_c - \\alpha\n",
    "\\end{equation*}\n",
    "\n",
    "Since this is a SAD experiment, we can assume $\\alpha$ is 90˚ when $\\Delta_{\\mathrm{ano}}$ is negative and 270˚ when it is positive. This formalism is based on [Thorn and Sheldrick, J Appl. Cryst. (2011)](https://www.ncbi.nlm.nih.gov/pmc/articles/PMC3246834/pdf/j-44-01285.pdf)."
   ]
  },
  {
   "cell_type": "markdown",
   "metadata": {},
   "source": [
    "---\n",
    "### Computing Structure Factor Amplitudes\n",
    "\n",
    "The dataset being used is the direct output from running scaling and merging in [AIMLESS](http://www.ccp4.ac.uk/html/aimless.html). As a first processing step, we need to convert the observed merged intensities, $I(+)$ and $I(-)$, into observed structure factor amplitudes, $F(+)$ and $F(-)$."
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 4,
   "metadata": {},
   "outputs": [
    {
     "data": {
      "text/html": [
       "<div>\n",
       "<style scoped>\n",
       "    .dataframe tbody tr th:only-of-type {\n",
       "        vertical-align: middle;\n",
       "    }\n",
       "\n",
       "    .dataframe tbody tr th {\n",
       "        vertical-align: top;\n",
       "    }\n",
       "\n",
       "    .dataframe thead th {\n",
       "        text-align: right;\n",
       "    }\n",
       "</style>\n",
       "<table border=\"1\" class=\"dataframe\">\n",
       "  <thead>\n",
       "    <tr style=\"text-align: right;\">\n",
       "      <th></th>\n",
       "      <th></th>\n",
       "      <th></th>\n",
       "      <th>FreeR_flag</th>\n",
       "      <th>IMEAN</th>\n",
       "      <th>SIGIMEAN</th>\n",
       "      <th>I</th>\n",
       "      <th>SIGI</th>\n",
       "      <th>N</th>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>H</th>\n",
       "      <th>K</th>\n",
       "      <th>L</th>\n",
       "      <th></th>\n",
       "      <th></th>\n",
       "      <th></th>\n",
       "      <th></th>\n",
       "      <th></th>\n",
       "      <th></th>\n",
       "    </tr>\n",
       "  </thead>\n",
       "  <tbody>\n",
       "    <tr>\n",
       "      <th rowspan=\"5\" valign=\"top\">-45</th>\n",
       "      <th rowspan=\"2\" valign=\"top\">-10</th>\n",
       "      <th>-1</th>\n",
       "      <td>19</td>\n",
       "      <td>6.4083962</td>\n",
       "      <td>1.9782588</td>\n",
       "      <td>5.543211</td>\n",
       "      <td>2.965243</td>\n",
       "      <td>4</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>0</th>\n",
       "      <td>16</td>\n",
       "      <td>7.999073</td>\n",
       "      <td>2.9954805</td>\n",
       "      <td>7.999073</td>\n",
       "      <td>2.9954805</td>\n",
       "      <td>4</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th rowspan=\"3\" valign=\"top\">-9</th>\n",
       "      <th>-2</th>\n",
       "      <td>11</td>\n",
       "      <td>26.471386</td>\n",
       "      <td>3.8778236</td>\n",
       "      <td>26.471386</td>\n",
       "      <td>3.8778236</td>\n",
       "      <td>4</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>-1</th>\n",
       "      <td>6</td>\n",
       "      <td>4.3246555</td>\n",
       "      <td>1.9706693</td>\n",
       "      <td>2.7027502</td>\n",
       "      <td>2.668546</td>\n",
       "      <td>4</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>0</th>\n",
       "      <td>17</td>\n",
       "      <td>60.28856</td>\n",
       "      <td>5.675214</td>\n",
       "      <td>60.28856</td>\n",
       "      <td>5.675214</td>\n",
       "      <td>4</td>\n",
       "    </tr>\n",
       "  </tbody>\n",
       "</table>\n",
       "</div>"
      ],
      "text/plain": [
       "            FreeR_flag     IMEAN  SIGIMEAN         I      SIGI  N\n",
       "H   K   L                                                        \n",
       "-45 -10 -1          19 6.4083962 1.9782588  5.543211  2.965243  4\n",
       "         0          16  7.999073 2.9954805  7.999073 2.9954805  4\n",
       "    -9  -2          11 26.471386 3.8778236 26.471386 3.8778236  4\n",
       "        -1           6 4.3246555 1.9706693 2.7027502  2.668546  4\n",
       "         0          17  60.28856  5.675214  60.28856  5.675214  4"
      ]
     },
     "execution_count": 4,
     "metadata": {},
     "output_type": "execute_result"
    }
   ],
   "source": [
    "# In order to scale the merged intensities, we must first get them into a single DataSet column\n",
    "stacked = refltable.stack_anomalous()\n",
    "stacked = stacked.loc[stacked[\"N\"] > 0]\n",
    "stacked.sort_index(inplace=True)\n",
    "stacked.head()"
   ]
  },
  {
   "cell_type": "markdown",
   "metadata": {},
   "source": [
    "In order to get structure factor amplitudes, we must first account for mean intensities that are negative due to background subtraction. We will use a method based on the Bayesian approach first proposed by [French and Wilson](https://scripts.iucr.org/cgi-bin/paper?a15572) to ensure that all intensities are strictly positive. This method is implemented in `reciprocalspaceship.algorithms.scale_merged_intensities()`."
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 5,
   "metadata": {},
   "outputs": [],
   "source": [
    "scaled = algorithms.scale_merged_intensities(stacked, \"I\", \"SIGI\", mean_intensity_method=\"anisotropic\")"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 6,
   "metadata": {},
   "outputs": [
    {
     "data": {
      "text/html": [
       "<div>\n",
       "<style scoped>\n",
       "    .dataframe tbody tr th:only-of-type {\n",
       "        vertical-align: middle;\n",
       "    }\n",
       "\n",
       "    .dataframe tbody tr th {\n",
       "        vertical-align: top;\n",
       "    }\n",
       "\n",
       "    .dataframe thead th {\n",
       "        text-align: right;\n",
       "    }\n",
       "</style>\n",
       "<table border=\"1\" class=\"dataframe\">\n",
       "  <thead>\n",
       "    <tr style=\"text-align: right;\">\n",
       "      <th></th>\n",
       "      <th></th>\n",
       "      <th></th>\n",
       "      <th>FreeR_flag</th>\n",
       "      <th>IMEAN</th>\n",
       "      <th>SIGIMEAN</th>\n",
       "      <th>I</th>\n",
       "      <th>SIGI</th>\n",
       "      <th>N</th>\n",
       "      <th>dHKL</th>\n",
       "      <th>CENTRIC</th>\n",
       "      <th>FW-I</th>\n",
       "      <th>FW-SIGI</th>\n",
       "      <th>FW-F</th>\n",
       "      <th>FW-SIGF</th>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>H</th>\n",
       "      <th>K</th>\n",
       "      <th>L</th>\n",
       "      <th></th>\n",
       "      <th></th>\n",
       "      <th></th>\n",
       "      <th></th>\n",
       "      <th></th>\n",
       "      <th></th>\n",
       "      <th></th>\n",
       "      <th></th>\n",
       "      <th></th>\n",
       "      <th></th>\n",
       "      <th></th>\n",
       "      <th></th>\n",
       "    </tr>\n",
       "  </thead>\n",
       "  <tbody>\n",
       "    <tr>\n",
       "      <th rowspan=\"5\" valign=\"top\">-45</th>\n",
       "      <th rowspan=\"2\" valign=\"top\">-10</th>\n",
       "      <th>-1</th>\n",
       "      <td>19</td>\n",
       "      <td>6.4083962</td>\n",
       "      <td>1.9782588</td>\n",
       "      <td>5.543211</td>\n",
       "      <td>2.965243</td>\n",
       "      <td>4</td>\n",
       "      <td>1.7194214</td>\n",
       "      <td>False</td>\n",
       "      <td>5.588304</td>\n",
       "      <td>2.7283347</td>\n",
       "      <td>2.3639593</td>\n",
       "      <td>0.57706887</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>0</th>\n",
       "      <td>16</td>\n",
       "      <td>7.999073</td>\n",
       "      <td>2.9954805</td>\n",
       "      <td>7.999073</td>\n",
       "      <td>2.9954805</td>\n",
       "      <td>4</td>\n",
       "      <td>1.7212021</td>\n",
       "      <td>True</td>\n",
       "      <td>7.1421466</td>\n",
       "      <td>3.141908</td>\n",
       "      <td>2.6724794</td>\n",
       "      <td>0.58782643</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th rowspan=\"3\" valign=\"top\">-9</th>\n",
       "      <th>-2</th>\n",
       "      <td>11</td>\n",
       "      <td>26.471386</td>\n",
       "      <td>3.8778236</td>\n",
       "      <td>26.471386</td>\n",
       "      <td>3.8778236</td>\n",
       "      <td>4</td>\n",
       "      <td>1.7217635</td>\n",
       "      <td>False</td>\n",
       "      <td>26.15096</td>\n",
       "      <td>3.8778236</td>\n",
       "      <td>5.113801</td>\n",
       "      <td>0.37915277</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>-1</th>\n",
       "      <td>6</td>\n",
       "      <td>4.3246555</td>\n",
       "      <td>1.9706693</td>\n",
       "      <td>2.7027502</td>\n",
       "      <td>2.668546</td>\n",
       "      <td>4</td>\n",
       "      <td>1.727144</td>\n",
       "      <td>False</td>\n",
       "      <td>3.3600478</td>\n",
       "      <td>2.0947244</td>\n",
       "      <td>1.8330433</td>\n",
       "      <td>0.5713789</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>0</th>\n",
       "      <td>17</td>\n",
       "      <td>60.28856</td>\n",
       "      <td>5.675214</td>\n",
       "      <td>60.28856</td>\n",
       "      <td>5.675214</td>\n",
       "      <td>4</td>\n",
       "      <td>1.728949</td>\n",
       "      <td>True</td>\n",
       "      <td>59.65461</td>\n",
       "      <td>5.68847</td>\n",
       "      <td>7.7236395</td>\n",
       "      <td>0.3682506</td>\n",
       "    </tr>\n",
       "  </tbody>\n",
       "</table>\n",
       "</div>"
      ],
      "text/plain": [
       "            FreeR_flag     IMEAN  SIGIMEAN         I      SIGI  N      dHKL  \\\n",
       "H   K   L                                                                     \n",
       "-45 -10 -1          19 6.4083962 1.9782588  5.543211  2.965243  4 1.7194214   \n",
       "         0          16  7.999073 2.9954805  7.999073 2.9954805  4 1.7212021   \n",
       "    -9  -2          11 26.471386 3.8778236 26.471386 3.8778236  4 1.7217635   \n",
       "        -1           6 4.3246555 1.9706693 2.7027502  2.668546  4  1.727144   \n",
       "         0          17  60.28856  5.675214  60.28856  5.675214  4  1.728949   \n",
       "\n",
       "            CENTRIC      FW-I   FW-SIGI      FW-F    FW-SIGF  \n",
       "H   K   L                                                     \n",
       "-45 -10 -1    False  5.588304 2.7283347 2.3639593 0.57706887  \n",
       "         0     True 7.1421466  3.141908 2.6724794 0.58782643  \n",
       "    -9  -2    False  26.15096 3.8778236  5.113801 0.37915277  \n",
       "        -1    False 3.3600478 2.0947244 1.8330433  0.5713789  \n",
       "         0     True  59.65461   5.68847 7.7236395  0.3682506  "
      ]
     },
     "execution_count": 6,
     "metadata": {},
     "output_type": "execute_result"
    }
   ],
   "source": [
    "scaled.head()"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 7,
   "metadata": {},
   "outputs": [],
   "source": [
    "# Remove columns that won't be used\n",
    "scaled = scaled[[\"FW-F\", \"FW-SIGF\", \"N\"]]"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 8,
   "metadata": {},
   "outputs": [],
   "source": [
    "# \"Unstack\" anomalous data from one-column to two-column format\n",
    "refltable = scaled.unstack_anomalous([\"FW-F\", \"FW-SIGF\", \"N\"]).dropna()"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 9,
   "metadata": {},
   "outputs": [
    {
     "data": {
      "text/html": [
       "<div>\n",
       "<style scoped>\n",
       "    .dataframe tbody tr th:only-of-type {\n",
       "        vertical-align: middle;\n",
       "    }\n",
       "\n",
       "    .dataframe tbody tr th {\n",
       "        vertical-align: top;\n",
       "    }\n",
       "\n",
       "    .dataframe thead th {\n",
       "        text-align: right;\n",
       "    }\n",
       "</style>\n",
       "<table border=\"1\" class=\"dataframe\">\n",
       "  <thead>\n",
       "    <tr style=\"text-align: right;\">\n",
       "      <th></th>\n",
       "      <th></th>\n",
       "      <th></th>\n",
       "      <th>FW-F(+)</th>\n",
       "      <th>FW-SIGF(+)</th>\n",
       "      <th>N(+)</th>\n",
       "      <th>FW-F(-)</th>\n",
       "      <th>FW-SIGF(-)</th>\n",
       "      <th>N(-)</th>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>H</th>\n",
       "      <th>K</th>\n",
       "      <th>L</th>\n",
       "      <th></th>\n",
       "      <th></th>\n",
       "      <th></th>\n",
       "      <th></th>\n",
       "      <th></th>\n",
       "      <th></th>\n",
       "    </tr>\n",
       "  </thead>\n",
       "  <tbody>\n",
       "    <tr>\n",
       "      <th rowspan=\"5\" valign=\"top\">0</th>\n",
       "      <th rowspan=\"5\" valign=\"top\">0</th>\n",
       "      <th>4</th>\n",
       "      <td>25.895874</td>\n",
       "      <td>0.42886934</td>\n",
       "      <td>16</td>\n",
       "      <td>25.895874</td>\n",
       "      <td>0.42886934</td>\n",
       "      <td>16</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>8</th>\n",
       "      <td>57.19014</td>\n",
       "      <td>0.9409411</td>\n",
       "      <td>16</td>\n",
       "      <td>57.190083</td>\n",
       "      <td>0.94094205</td>\n",
       "      <td>16</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>12</th>\n",
       "      <td>36.96789</td>\n",
       "      <td>0.5865023</td>\n",
       "      <td>16</td>\n",
       "      <td>36.96788</td>\n",
       "      <td>0.58650255</td>\n",
       "      <td>16</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>16</th>\n",
       "      <td>64.35631</td>\n",
       "      <td>1.5460751</td>\n",
       "      <td>8</td>\n",
       "      <td>64.356346</td>\n",
       "      <td>1.5460743</td>\n",
       "      <td>8</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>20</th>\n",
       "      <td>1.8891001</td>\n",
       "      <td>0.9376929</td>\n",
       "      <td>1</td>\n",
       "      <td>1.8891151</td>\n",
       "      <td>0.9376951</td>\n",
       "      <td>1</td>\n",
       "    </tr>\n",
       "  </tbody>\n",
       "</table>\n",
       "</div>"
      ],
      "text/plain": [
       "         FW-F(+)  FW-SIGF(+)  N(+)   FW-F(-)  FW-SIGF(-)  N(-)\n",
       "H K L                                                         \n",
       "0 0 4  25.895874  0.42886934    16 25.895874  0.42886934    16\n",
       "    8   57.19014   0.9409411    16 57.190083  0.94094205    16\n",
       "    12  36.96789   0.5865023    16  36.96788  0.58650255    16\n",
       "    16  64.35631   1.5460751     8 64.356346   1.5460743     8\n",
       "    20 1.8891001   0.9376929     1 1.8891151   0.9376951     1"
      ]
     },
     "execution_count": 9,
     "metadata": {},
     "output_type": "execute_result"
    }
   ],
   "source": [
    "refltable.head()"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 10,
   "metadata": {},
   "outputs": [],
   "source": [
    "# Compute differences\n",
    "dF    = np.abs(refltable[\"FW-F(+)\"] - refltable[\"FW-F(-)\"])\n",
    "sigDF = np.sqrt(refltable[\"FW-SIGF(+)\"]**2 + refltable[\"FW-SIGF(-)\"]**2)\n",
    "refltable[\"ANOM\"] = rs.DataSeries(dF, dtype=\"SFAmplitude\")\n",
    "refltable[\"SigANOM\"] = rs.DataSeries(sigDF, dtype=\"Stddev\")"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 11,
   "metadata": {},
   "outputs": [
    {
     "data": {
      "text/html": [
       "<div>\n",
       "<style scoped>\n",
       "    .dataframe tbody tr th:only-of-type {\n",
       "        vertical-align: middle;\n",
       "    }\n",
       "\n",
       "    .dataframe tbody tr th {\n",
       "        vertical-align: top;\n",
       "    }\n",
       "\n",
       "    .dataframe thead th {\n",
       "        text-align: right;\n",
       "    }\n",
       "</style>\n",
       "<table border=\"1\" class=\"dataframe\">\n",
       "  <thead>\n",
       "    <tr style=\"text-align: right;\">\n",
       "      <th></th>\n",
       "      <th></th>\n",
       "      <th></th>\n",
       "      <th>FW-F(+)</th>\n",
       "      <th>FW-SIGF(+)</th>\n",
       "      <th>N(+)</th>\n",
       "      <th>FW-F(-)</th>\n",
       "      <th>FW-SIGF(-)</th>\n",
       "      <th>N(-)</th>\n",
       "      <th>ANOM</th>\n",
       "      <th>SigANOM</th>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>H</th>\n",
       "      <th>K</th>\n",
       "      <th>L</th>\n",
       "      <th></th>\n",
       "      <th></th>\n",
       "      <th></th>\n",
       "      <th></th>\n",
       "      <th></th>\n",
       "      <th></th>\n",
       "      <th></th>\n",
       "      <th></th>\n",
       "    </tr>\n",
       "  </thead>\n",
       "  <tbody>\n",
       "    <tr>\n",
       "      <th rowspan=\"5\" valign=\"top\">0</th>\n",
       "      <th rowspan=\"5\" valign=\"top\">0</th>\n",
       "      <th>4</th>\n",
       "      <td>25.895874</td>\n",
       "      <td>0.42886934</td>\n",
       "      <td>16</td>\n",
       "      <td>25.895874</td>\n",
       "      <td>0.42886934</td>\n",
       "      <td>16</td>\n",
       "      <td>0.0</td>\n",
       "      <td>0.60651284</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>8</th>\n",
       "      <td>57.19014</td>\n",
       "      <td>0.9409411</td>\n",
       "      <td>16</td>\n",
       "      <td>57.190083</td>\n",
       "      <td>0.94094205</td>\n",
       "      <td>16</td>\n",
       "      <td>5.722046e-05</td>\n",
       "      <td>1.3306923</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>12</th>\n",
       "      <td>36.96789</td>\n",
       "      <td>0.5865023</td>\n",
       "      <td>16</td>\n",
       "      <td>36.96788</td>\n",
       "      <td>0.58650255</td>\n",
       "      <td>16</td>\n",
       "      <td>1.1444092e-05</td>\n",
       "      <td>0.82943964</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>16</th>\n",
       "      <td>64.35631</td>\n",
       "      <td>1.5460751</td>\n",
       "      <td>8</td>\n",
       "      <td>64.356346</td>\n",
       "      <td>1.5460743</td>\n",
       "      <td>8</td>\n",
       "      <td>3.8146973e-05</td>\n",
       "      <td>2.1864798</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>20</th>\n",
       "      <td>1.8891001</td>\n",
       "      <td>0.9376929</td>\n",
       "      <td>1</td>\n",
       "      <td>1.8891151</td>\n",
       "      <td>0.9376951</td>\n",
       "      <td>1</td>\n",
       "      <td>1.50203705e-05</td>\n",
       "      <td>1.3260995</td>\n",
       "    </tr>\n",
       "  </tbody>\n",
       "</table>\n",
       "</div>"
      ],
      "text/plain": [
       "         FW-F(+)  FW-SIGF(+)  N(+)   FW-F(-)  FW-SIGF(-)  N(-)           ANOM  \\\n",
       "H K L                                                                           \n",
       "0 0 4  25.895874  0.42886934    16 25.895874  0.42886934    16            0.0   \n",
       "    8   57.19014   0.9409411    16 57.190083  0.94094205    16   5.722046e-05   \n",
       "    12  36.96789   0.5865023    16  36.96788  0.58650255    16  1.1444092e-05   \n",
       "    16  64.35631   1.5460751     8 64.356346   1.5460743     8  3.8146973e-05   \n",
       "    20 1.8891001   0.9376929     1 1.8891151   0.9376951     1 1.50203705e-05   \n",
       "\n",
       "          SigANOM  \n",
       "H K L              \n",
       "0 0 4  0.60651284  \n",
       "    8   1.3306923  \n",
       "    12 0.82943964  \n",
       "    16  2.1864798  \n",
       "    20  1.3260995  "
      ]
     },
     "execution_count": 11,
     "metadata": {},
     "output_type": "execute_result"
    }
   ],
   "source": [
    "refltable.head()"
   ]
  },
  {
   "cell_type": "markdown",
   "metadata": {},
   "source": [
    "---\n",
    "### Obtaining Phases by Isomorphous Replacement\n",
    "\n",
    "In order to turn these anomalous differences into a map, we need to get phases. We will do that by isomorphous replacement with a published structure, [1VAT](https://www.rcsb.org/structure/1vat). Phases were generated from the PDB model using [phenix.fmodel](https://www.phenix-online.org/documentation/reference/fmodel.html), and then we will compute the necessary phase shifts in order to go from the conventional structure factor phases to phases associated with the anomalous scattering contributions. "
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 12,
   "metadata": {},
   "outputs": [],
   "source": [
    "ref = rs.read_mtz(\"data/1VAT_fmodel.mtz\")"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 13,
   "metadata": {},
   "outputs": [
    {
     "data": {
      "text/html": [
       "<div>\n",
       "<style scoped>\n",
       "    .dataframe tbody tr th:only-of-type {\n",
       "        vertical-align: middle;\n",
       "    }\n",
       "\n",
       "    .dataframe tbody tr th {\n",
       "        vertical-align: top;\n",
       "    }\n",
       "\n",
       "    .dataframe thead th {\n",
       "        text-align: right;\n",
       "    }\n",
       "</style>\n",
       "<table border=\"1\" class=\"dataframe\">\n",
       "  <thead>\n",
       "    <tr style=\"text-align: right;\">\n",
       "      <th></th>\n",
       "      <th></th>\n",
       "      <th></th>\n",
       "      <th>FMODEL</th>\n",
       "      <th>PHIFMODEL</th>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>H</th>\n",
       "      <th>K</th>\n",
       "      <th>L</th>\n",
       "      <th></th>\n",
       "      <th></th>\n",
       "    </tr>\n",
       "  </thead>\n",
       "  <tbody>\n",
       "    <tr>\n",
       "      <th rowspan=\"5\" valign=\"top\">0</th>\n",
       "      <th rowspan=\"5\" valign=\"top\">0</th>\n",
       "      <th>4</th>\n",
       "      <td>954.69275</td>\n",
       "      <td>180.0</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>8</th>\n",
       "      <td>1030.4215</td>\n",
       "      <td>-7.802343e-16</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>12</th>\n",
       "      <td>754.23175</td>\n",
       "      <td>4.4153507e-15</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>16</th>\n",
       "      <td>533.2781</td>\n",
       "      <td>0.0</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>20</th>\n",
       "      <td>5.3535447</td>\n",
       "      <td>0.0</td>\n",
       "    </tr>\n",
       "  </tbody>\n",
       "</table>\n",
       "</div>"
      ],
      "text/plain": [
       "          FMODEL     PHIFMODEL\n",
       "H K L                         \n",
       "0 0 4  954.69275         180.0\n",
       "    8  1030.4215 -7.802343e-16\n",
       "    12 754.23175 4.4153507e-15\n",
       "    16  533.2781           0.0\n",
       "    20 5.3535447           0.0"
      ]
     },
     "execution_count": 13,
     "metadata": {},
     "output_type": "execute_result"
    }
   ],
   "source": [
    "ref.head()"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 14,
   "metadata": {},
   "outputs": [],
   "source": [
    "# Find common HKL indices\n",
    "hkls = refltable.index.intersection(ref.index).sort_values()\n",
    "refltable = refltable.loc[hkls]"
   ]
  },
  {
   "cell_type": "markdown",
   "metadata": {},
   "source": [
    "As mentioned in [Background](anomalousdifference.ipynb#Background), we can compute the anomalous phases as follows:\n",
    "\n",
    "\\begin{equation*}\n",
    "\\phi_A = \\phi_c - \\alpha\n",
    "\\end{equation*}\n",
    "\n",
    "where $\\alpha$ is 90˚ when $\\Delta_{\\mathrm{ano}}$ is negative and 270˚ when it is positive."
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 15,
   "metadata": {},
   "outputs": [],
   "source": [
    "alpha = 90 + 180*(refltable[\"FW-F(+)\"] >= refltable[\"FW-F(-)\"])\n",
    "refltable[\"PHANOM\"] = ref.loc[hkls, \"PHIFMODEL\"] + alpha\n",
    "refltable[\"PHANOM\"] = rs.utils.canonicalize_phases(refltable[\"PHANOM\"].astype(\"Phase\"))"
   ]
  },
  {
   "cell_type": "markdown",
   "metadata": {},
   "source": [
    "### Viewing the Map  \n",
    "\n",
    "Since we have structure factor amplitudes, `refltable[\"ANOM\"]`, and phases, `refltable[\"PHANOM\"]`, for the anomalous structure factors, we can now view the anomalous difference map. This can be done by writing out an MTZ file, and loading it into COOT, PyMOL, or any other molecular graphics package. "
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 16,
   "metadata": {},
   "outputs": [
    {
     "data": {
      "text/plain": [
       "FW-F(+)       FriedelSFAmplitude\n",
       "FW-SIGF(+)       StddevFriedelSF\n",
       "N(+)                      MTZInt\n",
       "FW-F(-)       FriedelSFAmplitude\n",
       "FW-SIGF(-)       StddevFriedelSF\n",
       "N(-)                      MTZInt\n",
       "ANOM                 SFAmplitude\n",
       "SigANOM                   Stddev\n",
       "PHANOM                     Phase\n",
       "dtype: object"
      ]
     },
     "execution_count": 16,
     "metadata": {},
     "output_type": "execute_result"
    }
   ],
   "source": [
    "refltable.dtypes"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 17,
   "metadata": {},
   "outputs": [],
   "source": [
    "refltable.write_mtz(\"data/anomdiff.mtz\")"
   ]
  },
  {
   "cell_type": "markdown",
   "metadata": {},
   "source": [
    "Looking at the anomalous difference map on the `1VAT` structure, we can see positive difference density on all of the sulfurs in HEWL (shown below in purple):"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 18,
   "metadata": {
    "scrolled": false
   },
   "outputs": [
    {
     "data": {
      "text/html": [
       "<center>\n",
       "    <iframe src=\"https://hekstra-lab.github.io/reciprocalspaceship/data/anomdiff/anomdiff.html#zoom=25\", width=600, height=600></iframe>\n",
       "    <br>Anomalous difference map from HEWL crystal overlayed with <b>PDB: 1VAT</b>. Map is contoured at +5&sigma;.\n",
       "</center>\n"
      ],
      "text/plain": [
       "<IPython.core.display.HTML object>"
      ]
     },
     "metadata": {},
     "output_type": "display_data"
    }
   ],
   "source": [
    "%%html\n",
    "<center>\n",
    "    <iframe src=\"https://hekstra-lab.github.io/reciprocalspaceship/data/anomdiff/anomdiff.html#zoom=25\", width=600, height=600></iframe>\n",
    "    <br>Anomalous difference map from HEWL crystal overlayed with <b>PDB: 1VAT</b>. Map is contoured at +5&sigma;.\n",
    "</center>"
   ]
  }
 ],
 "metadata": {
  "kernelspec": {
   "display_name": "Python 3",
   "language": "python",
   "name": "python3"
  },
  "language_info": {
   "codemirror_mode": {
    "name": "ipython",
    "version": 3
   },
   "file_extension": ".py",
   "mimetype": "text/x-python",
   "name": "python",
   "nbconvert_exporter": "python",
   "pygments_lexer": "ipython3",
   "version": "3.8.5"
  }
 },
 "nbformat": 4,
 "nbformat_minor": 2
}
